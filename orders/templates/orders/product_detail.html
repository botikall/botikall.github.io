{% extends 'orders/base.html' %}

{% block content %}
<div class="product-container" style="margin-top: 130px; display: flex; align-items: flex-start; gap: 20px; width: 100%;">
    <div class="product-image" style="flex: 1; width: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden;">
        {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" style="width: 100%; height: auto; object-fit: cover; border-radius: 8px;">
        {% endif %}
    </div>

    <div class="product-info" style="flex: 1; width: 50%; display: flex; flex-direction: column; justify-content: space-between;">
        <h1 class="product-title">{{ product.name }}</h1>
        <div class="product-details" style="display: flex; justify-content: space-between; font-size: 14px; color: #666;">
            <span>–ê—Ä—Ç–∏–∫—É–ª: {{ product.article }}</span>
            <span>{{ product.weight }} –≥</span>
        </div>

        <p class="product-price" style="font-size: 22px; font-weight: bold; color: black;">{{ product.price }} –≥—Ä–Ω</p>

        <div class="product-buttons">
            {% if request.user.is_authenticated %}
                <form method="post" action="{% url 'add_to_cart' product.id %}" style="display: flex; flex-direction: column; align-items: flex-start;">
                    {% csrf_token %}
                    <label for="quantity">–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</label>
                    <input type="number" name="quantity" id="quantity" value="1" min="1" style="width: 60px; text-align: center; margin-bottom: 10px;">
                    <button type="submit" class="btn-submit">–î–æ–¥–∞—Ç–∏ –¥–æ –∫–æ—à–∏–∫–∞</button>
                </form>
            {% else %}
                <a href="{% url 'login' %}?next={% url 'cart' %}" class="btn-submit">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</a>
            {% endif %}
        </div>

        <div class="tabs" style="display: flex; border-bottom: 2px solid #eee; margin-top: 20px;">
            <div class="tab active" onclick="openTab(event, 'description')" style="padding: 10px 15px; cursor: pointer; font-weight: bold; color: #888;">–û–ü–ò–°</div>
            <div class="tab" onclick="openTab(event, 'composition')" style="padding: 10px 15px; cursor: pointer; font-weight: bold; color: #888;">–°–ö–õ–ê–î</div>
            <div class="tab" onclick="openTab(event, 'reviews')" style="padding: 10px 15px; cursor: pointer; font-weight: bold; color: #888;">–í–Ü–î–ì–£–ö–ò</div>
        </div>

        <div id="description" class="tab-content active" style="padding: 15px; display: block;">
            <p>{{ product.description }}</p>
        </div>
        <div id="composition" class="tab-content" style="padding: 15px; display: none;">
            <p>{{ product.composition }}</p>
        </div>
        <div id="reviews" class="tab-content" style="padding: 15px; display: none;">
            <p>–í—ñ–¥–≥—É–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –±—É–¥—É—Ç—å —Ç—É—Ç.</p>
            {% if user.is_authenticated %}
                {% if has_purchased %}
                    <div id="review-form-{{ product.id }}" class="review-form">
                        <form method="post" onsubmit="submitReview(event, {{ order.id }})">

                            {% csrf_token %}
                            <input type="hidden" name="product_id" value="{{ product.id }}">

                            <label for="rating">–û—Ü—ñ–Ω–∫–∞:</label>
                            <div class="star-rating" data-product-id="{{ product.id }}">
                                <span class="star" data-value="5">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="1">‚òÖ</span>
                            </div>
                            <input type="hidden" name="rating" id="rating-input-{{ product.id }}" required>

                            <label for="text">–ö–æ–º–µ–Ω—Ç–∞—Ä:</label>
                            <textarea name="text" required></textarea>

                            <button type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
                        </form>
                    </div>
                {% else %}
                    <p>–í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫ –ª–∏—à–µ –ø—ñ—Å–ª—è –ø–æ–∫—É–ø–∫–∏ —Ü—å–æ–≥–æ —Ç–æ–≤–∞—Ä—É.</p>
                {% endif %}
            {% else %}
                <p>–ë—É–¥—å –ª–∞—Å–∫–∞, <a href="{% url 'login' %}">—É–≤—ñ–π–¥—ñ—Ç—å</a>, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫.</p>
            {% endif %}
        </div>
    </div>
</div>



<div class="container">
        <h2 style="text-align: center;">–¢–æ–ø –ø—Ä–æ–¥—É–∫—Ü—ñ—è</h2>

        <div class="swiper-wrapper-container">

            <div class="swiper-container">
                <div class="swiper-wrapper">
                    {% for product in products %}
                    <div class="swiper-slide">
                        <div class="product-card" style="display: flex; flex-direction: column; justify-content: space-between; align-items: center; min-height: 470px; border: 1px solid #ddd; border-radius: 10px; padding: 15px; text-align: center; background: #fff; box-shadow: 2px 2px 10px rgba(0,0,0,0.1);">
                            {% if product.image %}
                                <a href="{% url 'product_detail' product.id %}">
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px;">
                                </a>
                            {% endif %}
                            <h3 style="margin-top: 10px;">
                                <a href="{% url 'product_detail' product.id %}" style="text-decoration: none; color: inherit;">{{ product.name }}</a>
                            </h3>
                            <p>{{ product.description }}</p>
                            <p style="font-weight: bold;">–¶—ñ–Ω–∞: {{ product.price }} –≥—Ä–Ω</p>

                            <div style="width: 100%;">
                                {% if request.user.is_authenticated %}
                                    <form method="post" action="{% url 'add_to_cart' product.id %}" style="display: flex; flex-direction: column; align-items: center;">
                                        {% csrf_token %}
                                        <label for="quantity">–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</label>
                                        <input type="number" name="quantity" id="quantity" value="1" min="1" style="width: 60px; text-align: center; margin-bottom: 10px;">
                                        <button type="submit" class="btn-submit">–î–æ–¥–∞—Ç–∏ –¥–æ –∫–æ—à–∏–∫–∞</button>
                                    </form>
                                {% else %}
                                    <a href="{% url 'login' %}?next={% url 'cart' %}" class="btn-submit">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

            </div>
            <div class="swiper-button-prev custom-prev"></div>
            <div class="swiper-button-next custom-next"></div>
        </div>

        <div class="more-comments" style="margin-top: 0px;">
            <a href="{% url 'product_list' %}" class="more-btn">–ë—ñ–ª—å—à–µ –ø—Ä–æ–¥—É–∫—Ü—ñ—ó</a>
        </div>
    </div>
<style>

/* –°—Ç–∏–ª—ñ –¥–ª—è –∑—ñ—Ä–æ—á–æ–∫ */
.star-rating {
    display: flex;
    flex-direction: row-reverse; /* –†–µ–≤–µ—Ä—Å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ hover */
    justify-content: center;
    gap: 5px;
}

.star {
    font-size: 20px;
    cursor: pointer;
    color: #ccc;
    transition: color 0.3s ease-in-out, transform 0.2s ease-in-out;
    user-select: none;
}




/* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –∑–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä –ø–æ—Ç–æ—á–Ω–æ—ó –∑—ñ—Ä–∫–∏ —Ç–∞ –≤—Å—ñ—Ö –ª—ñ–≤–æ—Ä—É—á */
.star:hover,
.star:hover ~ .star {
    color: pink;
    transform: scale(1.1);
}

/* –î–ª—è –∞–∫—Ç–∏–≤–Ω–∏—Ö (–≤–∏–±—Ä–∞–Ω–∏—Ö) –∑—ñ—Ä–æ–∫ */
.star.selected,
.star.selected ~ .star {
    color: pink;
}


    /* –°—Ç–∏–ª—ñ –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø—Ä–æ–¥—É–∫—Ç—É */
.product-container {
    max-width: 1280px;
    margin: 0 auto;
    text-align: left;
}

.product-image img {
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    border-radius: 8px;
}

.product-title {
    font-size: 24px;
    font-weight: bold;
    margin-top: 10px;
}

.product-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    font-size: 14px;
    color: #666;
}

.product-price {
    font-size: 22px;
    font-weight: bold;
    color: #f6cece;
}

.tabs {
    display: flex;
    border-bottom: 2px solid #eee;
    margin-top: 20px;
}

.tab {
    padding: 10px 15px;
    cursor: pointer;
    font-weight: bold;
    color: #888;
}

.tab.active {
    color: #f6cece;
    border-bottom: 3px solid #f6cece;
}

.tab-content {
    padding: 15px;
    display: none;
}

.tab-content.active {
    display: block;
}

    /* –û–±–≥–æ—Ä—Ç–∫–∞ –¥–ª—è Swiper */
.swiper-wrapper-container {
    position: relative; /* –©–æ–± –∫–Ω–æ–ø–∫–∏ –ø–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–ª–∏—Å—è –≤—ñ–¥–Ω–æ—Å–Ω–æ –Ω–µ—ó */
    max-width: 1500px;
    margin: 0 auto;
}
 /* –°—Ç–∏–ª—ñ Swiper */
.swiper-container {
    overflow: hidden;
    padding: 20px;
    position: relative;
    max-width: 1280px;
    margin: 0 auto;
    padding: 20px 0;
}


.swiper-wrapper {
    display: flex;
    align-items: stretch; /* –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –ø–æ –≤–∏—Å–æ—Ç—ñ */
}

.swiper-slide {
    background: none !important; /* –ó–∞–±–∏—Ä–∞—î –±—ñ–ª–∏–π —Ñ–æ–Ω */
    padding: 0 !important;
    display: flex;
    height: auto; /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –≤–∏—Å–æ—Ç–∞ */
    align-items: stretch; /* –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –≤–∏—Å–æ—Ç–∏ –≤—Å—ñ—Ö –∫–∞—Ä—Ç–æ–∫ */
}

/* –§—ñ–∫—Å–∞—Ü—ñ—è –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Ä—ñ–≤–Ω—ñ —Å–ª–∞–π–¥—ñ–≤ */
.swiper-button-prev,
.swiper-button-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 45px;
    height: 45px;
    background: #f6cece; /* –ù–û–í–ò–ô –ö–û–õ–Ü–† */
    color: white;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    z-index: 9;
}

/* –ó–º–µ–Ω—à–µ–Ω–æ –≤—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –∫—Ä–∞—ó–≤ */
.swiper-button-prev {
    left: -60px;
}

.swiper-button-next {
    right: -60px;
}

/* –î–æ–¥–∞—Ç–∫–æ–≤–µ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
@media (max-width: 768px) {
    .swiper-button-prev {
        left: 5px;
    }
    .swiper-button-next {
        right: 5px;
    }
}
</style>
<script>
    function submitReview(event, orderId) {
    event.preventDefault();  // –ó–∞–ø–æ–±—ñ–≥–∞—î –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—é —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –æ–¥—Ä–∞–∑—É

    let form = event.target;
    let formData = new FormData(form);
    let csrfToken = form.querySelector("[name=csrfmiddlewaretoken]").value;

    fetch("{% url 'add_comment_for_product' %}", {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();  // üîÑ –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
        } else {
            alert("–ü–æ–º–∏–ª–∫–∞: " + data.error);
        }
    })
    .catch(error => console.error("–ü–æ–º–∏–ª–∫–∞:", error));
}

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".star-rating").forEach(ratingContainer => {
        let stars = Array.from(ratingContainer.querySelectorAll(".star")).reverse(); // –†–µ–≤–µ—Ä—Å—É—î–º–æ –ø–æ—Ä—è–¥–æ–∫ –∑—ñ—Ä–æ–∫

        stars.forEach(star => {
            star.addEventListener("click", function () {
                let productId = this.parentElement.getAttribute("data-product-id"); // –ó–º—ñ–Ω–µ–Ω–æ –Ω–∞ productId
                let ratingInput = document.getElementById(`rating-input-${productId}`);
                let selectedValue = parseInt(this.getAttribute("data-value"));

                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—É –≤ –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ –ø–æ–ª–µ
                ratingInput.value = selectedValue;

                // –û—á–∏—â–∞—î–º–æ –ø—ñ–¥—Å–≤—ñ—á–µ–Ω–Ω—è –≤—Å—ñ—Ö –∑—ñ—Ä–æ–∫
                stars.forEach(s => s.classList.remove("selected"));

                // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å "selected" –¥–ª—è –≤–∏–±—Ä–∞–Ω–æ—ó –∑—ñ—Ä–∫–∏ —ñ –≤—Å—ñ—Ö –ø–µ—Ä–µ–¥ –Ω–µ—é
                stars.forEach(s => {
                    if (parseInt(s.getAttribute("data-value")) >= selectedValue) {
                        s.classList.add("selected");
                    }
                });
            });
        });
    });
});

     function openTab(event, tabName) {
        // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –≤–∫–ª–∞–¥–æ–∫ —ñ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —ó—Ö
        let tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(tab => tab.style.display = 'none');

        // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –∫–Ω–æ–ø–∫–∏ –≤–∫–ª–∞–¥–æ–∫ —ñ –∑–Ω—ñ–º–∞—î–º–æ –∫–ª–∞—Å 'active'
        let tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => tab.classList.remove('active'));

        // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç —ñ –¥–æ–¥–∞—î–º–æ 'active' –¥–æ –æ–±—Ä–∞–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏
        document.getElementById(tabName).style.display = 'block';
        event.currentTarget.classList.add('active');
    }

    // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∞–∫—Ç–∏–≤—É—î–º–æ –ø–µ—Ä—à—É –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelector('.tab').click();
    });

     var swiper = new Swiper(".swiper-container", {
        slidesPerView: 4, // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ 4 –ø—Ä–æ–¥—É–∫—Ç–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ
        spaceBetween: 20, // –í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ —Å–ª–∞–π–¥–∞–º–∏
        loop: true, // –ó–∞—Ü–∏–∫–ª–µ–Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
        centeredSlides: false,
        navigation: {
            nextEl: ".custom-next",
            prevEl: ".custom-prev",
        },
        breakpoints: {
            1024: {
                slidesPerView: 4, // –î–ª—è –≤–µ–ª–∏–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤
            },
            768: {
                slidesPerView: 2, // –î–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤
            },
            480: {
                slidesPerView: 1, // –î–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö
            }
        }
    });
</script>
{% endblock %}